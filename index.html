<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roadworks Visualization</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .main-container {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }

        .controls {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow-y: auto;
        }

        .controls h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .tool-group {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 15px;
            border-left: 4px solid #3498db;
        }

        .tool-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .tool-btn {
            width: 100%;
            padding: 12px 16px;
            margin: 8px 0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tool-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .tool-btn:hover:before {
            left: 100%;
        }

        .tool-btn.roadworks {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .tool-btn.roadworks:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .tool-btn.car-diversion {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .tool-btn.car-diversion:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .tool-btn.bike-diversion {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .tool-btn.bike-diversion:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .tool-btn.clear, .tool-btn.export {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .tool-btn.clear:hover, .tool-btn.export:hover {
            background: linear-gradient(135deg, #7f8c8d, #566573);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }

        .tool-btn.active {
            transform: scale(0.95);
            box-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.3);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .roadwork-form {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #e74c3c;
            display: none;
        }

        .roadwork-form.active {
            display: block;
        }

        .roadwork-form h4 {
            color: #e74c3c;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .map-container {
            flex: 1;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }

        .status {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }

        .status h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .status p {
            color: #7f8c8d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .legend {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }

        .legend h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .legend-color.roadworks {
            background: #e74c3c;
        }

        .legend-color.car {
            background: #3498db;
        }

        .legend-color.bike {
            background: #27ae60;
        }

        .legend-text {
            color: #2c3e50;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .polygon-instructions {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #c0392b;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .date-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .date-input-group .input-group {
            flex: 1;
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .controls {
                width: 100%;
                max-height: 400px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚧 Roadworks Visualization</h1>
        <p>Create roadwork polygons and draw traffic diversions</p>
    </div>

    <div class="main-container">
        <div class="controls">
            <h2>Tools</h2>
            
            <div class="tool-group">
                <h3>Roadworks</h3>
                <button class="tool-btn roadworks" onclick="setMode('roadworks')">
                    🚧 Draw Roadwork Area
                </button>
                
                <div class="roadwork-form" id="roadwork-form">
                    <h4>Roadwork Details</h4>
                    <div class="input-group">
                        <label for="roadwork-title">Title:</label>
                        <input type="text" id="roadwork-title" placeholder="e.g., Main Street Construction">
                    </div>
                    <div class="date-input-group">
                        <div class="input-group">
                            <label for="start-date">Start Date:</label>
                            <input type="date" id="start-date">
                        </div>
                        <div class="input-group">
                            <label for="end-date">End Date:</label>
                            <input type="date" id="end-date">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="roadwork-id">Unique ID:</label>
                        <input type="text" id="roadwork-id" placeholder="e.g., RW-2024-001">
                    </div>
                    <div class="input-group">
                        <label for="car-impact">Car Traffic Impact:</label>
                        <select id="car-impact">
                            <option value="none">No Impact</option>
                            <option value="minor">Minor Delays</option>
                            <option value="moderate">Moderate Delays</option>
                            <option value="major">Major Delays</option>
                            <option value="blocked">Road Blocked</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="cyclist-impact">Cyclist Impact:</label>
                        <select id="cyclist-impact">
                            <option value="none">No Impact</option>
                            <option value="minor">Minor Delays</option>
                            <option value="moderate">Moderate Delays</option>
                            <option value="major">Major Delays</option>
                            <option value="blocked">Path Blocked</option>
                        </select>
                    </div>
                    <div class="polygon-instructions">
                        Click on the map to create polygon points. Double-click to finish the polygon.
                    </div>
                </div>
            </div>

            <div class="tool-group">
                <h3>Diversions</h3>
                <button class="tool-btn car-diversion" onclick="setMode('car')">
                    🚗 Draw Car Diversion
                </button>
                <button class="tool-btn bike-diversion" onclick="setMode('bike')">
                    🚴 Draw Bike Diversion
                </button>
            </div>

            <div class="tool-group">
                <h3>Actions</h3>
                <button class="tool-btn export" onclick="exportGeoJSON()">
                    💾 Export GeoJSON
                </button>
                <button class="tool-btn clear" onclick="clearAll()">
                    🗑️ Clear All
                </button>
            </div>

            <div class="status">
                <h4>Current Mode</h4>
                <p id="status-text">Click a tool to start</p>
            </div>

            <div class="legend">
                <h4>Legend</h4>
                <div class="legend-item">
                    <div class="legend-color roadworks"></div>
                    <span class="legend-text">Roadworks Area</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color car"></div>
                    <span class="legend-text">Car Diversion</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color bike"></div>
                    <span class="legend-text">Bike Diversion</span>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([50.8503, 4.3517], 13); // Brussels coordinates

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Global variables
        let currentMode = null;
        let isDrawing = false;
        let currentPath = [];
        let roadworkAreas = [];
        let carDiversions = [];
        let bikeDiversions = [];
        let tempMarkers = [];
        let polygonPoints = [];

        // Set drawing mode
        function setMode(mode) {
            currentMode = mode;
            isDrawing = false;
            currentPath = [];
            polygonPoints = [];
            
            // Clear temporary markers
            tempMarkers.forEach(marker => map.removeLayer(marker));
            tempMarkers = [];
            
            // Update button states
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tool-btn.${mode === 'roadworks' ? 'roadworks' : mode + '-diversion'}`).classList.add('active');
            
            // Show/hide roadwork form
            const roadworkForm = document.getElementById('roadwork-form');
            if (mode === 'roadworks') {
                roadworkForm.classList.add('active');
            } else {
                roadworkForm.classList.remove('active');
            }
            
            // Update status
            const statusText = document.getElementById('status-text');
            switch(mode) {
                case 'roadworks':
                    statusText.textContent = 'Click on the map to create polygon points, double-click to finish';
                    break;
                case 'car':
                    statusText.textContent = 'Click to start drawing car diversion route';
                    break;
                case 'bike':
                    statusText.textContent = 'Click to start drawing bike diversion route';
                    break;
            }
        }

        // Clear all elements
        function clearAll() {
            roadworkAreas.forEach(area => {
                map.removeLayer(area.polygon);
                if (area.popup) map.removeLayer(area.popup);
            });
            carDiversions.forEach(route => {
                map.removeLayer(route.route);
                map.removeLayer(route.startMarker);
                map.removeLayer(route.endMarker);
            });
            bikeDiversions.forEach(route => {
                map.removeLayer(route.route);
                map.removeLayer(route.startMarker);
                map.removeLayer(route.endMarker);
            });
            tempMarkers.forEach(marker => map.removeLayer(marker));
            
            roadworkAreas = [];
            carDiversions = [];
            bikeDiversions = [];
            tempMarkers = [];
            currentPath = [];
            polygonPoints = [];
            isDrawing = false;
            
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('roadwork-form').classList.remove('active');
            document.getElementById('status-text').textContent = 'All elements cleared. Click a tool to start.';
        }

        // Export GeoJSON
        function exportGeoJSON() {
            const geojson = {
                type: "FeatureCollection",
                features: []
            };

            // Add roadwork areas
            roadworkAreas.forEach(area => {
                const feature = {
                    type: "Feature",
                    geometry: {
                        type: "Polygon",
                        coordinates: [area.polygon.getLatLngs()[0].map(latlng => [latlng.lng, latlng.lat])]
                    },
                    properties: {
                        type: "roadwork",
                        id: area.id,
                        title: area.title,
                        startDate: area.startDate,
                        endDate: area.endDate,
                        carImpact: area.carImpact,
                        cyclistImpact: area.cyclistImpact
                    }
                };
                geojson.features.push(feature);
            });

            // Add car diversions
            carDiversions.forEach(route => {
                const feature = {
                    type: "Feature",
                    geometry: {
                        type: "LineString",
                        coordinates: route.route.getLatLngs().map(latlng => [latlng.lng, latlng.lat])
                    },
                    properties: {
                        type: "car_diversion"
                    }
                };
                geojson.features.push(feature);
            });

            // Add bike diversions
            bikeDiversions.forEach(route => {
                const feature = {
                    type: "Feature",
                    geometry: {
                        type: "LineString",
                        coordinates: route.route.getLatLngs().map(latlng => [latlng.lng, latlng.lat])
                    },
                    properties: {
                        type: "bike_diversion"
                    }
                };
                geojson.features.push(feature);
            });

            // Download the file
            const dataStr = JSON.stringify(geojson, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'roadworks_' + new Date().toISOString().split('T')[0] + '.geojson';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Get impact color
        function getImpactColor(impact) {
            switch(impact) {
                case 'none': return '#2ecc71';
                case 'minor': return '#f39c12';
                case 'moderate': return '#e67e22';
                case 'major': return '#e74c3c';
                case 'blocked': return '#8e44ad';
                default: return '#95a5a6';
            }
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'Not specified';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Map click handler
        map.on('click', function(e) {
            if (!currentMode) return;
            
            const latlng = e.latlng;
            
            if (currentMode === 'roadworks') {
                // Add point to polygon
                polygonPoints.push(latlng);
                
                // Add temporary marker
                const marker = L.circleMarker(latlng, {
                    color: '#e74c3c',
                    fillColor: '#e74c3c',
                    fillOpacity: 0.8,
                    radius: 5
                }).addTo(map);
                tempMarkers.push(marker);
                
                // Draw temporary lines
                if (polygonPoints.length > 1) {
                    const line = L.polyline([polygonPoints[polygonPoints.length - 2], latlng], {
                        color: '#e74c3c',
                        weight: 2,
                        dashArray: '5, 5'
                    }).addTo(map);
                    tempMarkers.push(line);
                }
                
                document.getElementById('status-text').textContent = `${polygonPoints.length} points added. Double-click to finish polygon.`;
                
            } else if (currentMode === 'car' || currentMode === 'bike') {
                // Handle route drawing
                if (!isDrawing) {
                    // Start drawing
                    isDrawing = true;
                    currentPath = [latlng];
                    
                    // Add start marker
                    const startMarker = L.marker(latlng, {
                        icon: L.divIcon({
                            html: currentMode === 'car' ? '🚗' : '🚴',
                            className: 'emoji-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(map);
                    
                    tempMarkers.push(startMarker);
                    
                    document.getElementById('status-text').textContent = 'Click to add waypoints, double-click to finish route';
                    
                } else {
                    // Add waypoint
                    currentPath.push(latlng);
                    
                    // Draw temporary line
                    if (currentPath.length > 1) {
                        const color = currentMode === 'car' ? '#3498db' : '#27ae60';
                        const line = L.polyline(currentPath, {
                            color: color,
                            weight: 4,
                            opacity: 0.7,
                            dashArray: '10, 10'
                        }).addTo(map);
                        
                        tempMarkers.push(line);
                    }
                }
            }
        });

        // Map double-click handler
        map.on('dblclick', function(e) {
            if (currentMode === 'roadworks' && polygonPoints.length >= 3) {
                // Finish polygon
                const title = document.getElementById('roadwork-title').value || 'Roadwork Area';
                const id = document.getElementById('roadwork-id').value || 'RW-' + Date.now();
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const carImpact = document.getElementById('car-impact').value;
                const cyclistImpact = document.getElementById('cyclist-impact').value;
                
                // Remove temporary markers
                tempMarkers.forEach(marker => map.removeLayer(marker));
                tempMarkers = [];
                
                // Create polygon
                const polygon = L.polygon(polygonPoints, {
                    color: '#e74c3c',
                    fillColor: '#e74c3c',
                    fillOpacity: 0.4,
                    weight: 3
                }).addTo(map);
                
                // Create popup content
                const popupContent = `
                    <div style="padding: 10px; min-width: 250px;">
                        <h3 style="margin: 0 0 10px 0; color: #e74c3c;">🚧 ${title}</h3>
                        <div style="margin: 5px 0; font-size: 0.85em; color: #666;">
                            <strong>ID:</strong> ${id}
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>Period:</strong> ${formatDate(startDate)} - ${formatDate(endDate)}
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>Car Impact:</strong> 
                            <span style="color: ${getImpactColor(carImpact)}; font-weight: bold;">${carImpact}</span>
                        </div>
                        <div style="margin: 5px 0;">
                            <strong>Cyclist Impact:</strong> 
                            <span style="color: ${getImpactColor(cyclistImpact)}; font-weight: bold;">${cyclistImpact}</span>
                        </div>
                    </div>
                `;
                
                polygon.bindPopup(popupContent);
                
                // Store roadwork area
                roadworkAreas.push({
                    polygon: polygon,
                    id: id,
                    title: title,
                    startDate: startDate,
                    endDate: endDate,
                    carImpact: carImpact,
                    cyclistImpact: cyclistImpact
                });
                
                // Reset
                polygonPoints = [];
                document.getElementById('roadwork-title').value = '';
                document.getElementById('roadwork-id').value = '';
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
                document.getElementById('car-impact').value = 'none';
                document.getElementById('cyclist-impact').value = 'none';
                document.getElementById('status-text').textContent = 'Polygon created! Fill in details and create another, or select a different tool.';
                
            } else if ((currentMode === 'car' || currentMode === 'bike') && isDrawing && currentPath.length >= 2) {
                // Finish route
                tempMarkers.forEach(marker => map.removeLayer(marker));
                tempMarkers = [];
                
                currentPath.push(e.latlng);
                
                const color = currentMode === 'car' ? '#3498db' : '#27ae60';
                const emoji = currentMode === 'car' ? '🚗' : '🚴';
                const routeType = currentMode === 'car' ? 'Car' : 'Bike';
                
                const route = L.polyline(currentPath, {
                    color: color,
                    weight: 5,
                    opacity: 0.8
                }).addTo(map);
                
                route.bindPopup(`
                    <div style="text-align: center; padding: 10px;">
                        <h3 style="margin: 0 0 10px 0; color: ${color};">${emoji} ${routeType} Diversion</h3>
                        <p style="margin: 0; color: #666;">Alternative route</p>
                    </div>
                `);
                
                const startMarker = L.marker(currentPath[0], {
                    icon: L.divIcon({
                        html: `<div style="background: ${color}; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                        className: 'route-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                const endMarker = L.marker(currentPath[currentPath.length - 1], {
                    icon: L.divIcon({
                        html: `<div style="background: ${color}; border-radius: 50%; width: 20px; height: 20px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"><div style="color: white; font-size: 12px; line-height: 16px; text-align: center;">🏁</div></div>`,
                        className: 'route-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                const routeData = {
                    route: route,
                    startMarker: startMarker,
                    endMarker: endMarker
                };
                
                if (currentMode === 'car') {
                    carDiversions.push(routeData);
                } else {
                    bikeDiversions.push(routeData);
                }
                
                isDrawing = false;
                currentPath = [];
                document.getElementById('status-text').textContent = `${routeType} diversion route created. Click to create another or select a different tool.`;
            }
        });

        // Add custom CSS for emoji markers
        const style = document.createElement('style');
        style.textContent = `
            .emoji-marker {
                background: none !important;
                border: none !important;
                font-size: 20px;
                text-align: center;
                line-height: 30px;
            }
            .route-marker {
                background: none !important;
                border: none !important;
            }
        `;
        document.head.appendChild(style);

        // Initialize
        document.getElementById('status-text').textContent = 'Map loaded. Select a tool to start adding roadworks and diversions.';
    </script>
</body>
</html>
